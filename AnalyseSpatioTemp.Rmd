---
title: "Projet_Velo"
output:
  pdf_document: default
  html_document: default
date: "2024-09-21"
---

```{r}
path <- "C:/Users/pc/Documents/Projet/GUT"
library(readr)
vl <- read_csv(file.path(path, "accidentsVelo.csv"))
head(vl)
summary(vl)
```
```{r}
library(tidyr)
library(dplyr)

# Suppression des lignes avec des valeurs manquantes 
vl <- vl %>%
  drop_na()  # Supprime les lignes avec NA

# Vérifier les doublons et les supprimer si nécessaire
vl <- vl %>%
  distinct()

```

```{r}
# Conversion des colonnes de latitude et de longitude en numériques
vl$lat <- as.numeric(vl$lat)
vl$long <- as.numeric(vl$long)

# Vérification des valeurs après conversion
summary(vl$lat)
summary(vl$long)

# Vérification des NAs après conversion
na_latitude <- vl[is.na(vl$lat), ]
na_longitude <- vl[is.na(vl$long), ]

# Suppression des lignes avec des valeurs NA (si nécessaire)
vl <- vl %>%
  filter(!is.na(lat) & !is.na(long))
# Vérification des valeurs manquantes dans les colonnes latitude et longitude
summary(vl$lat)
summary(vl$long)

# Afficher les lignes avec des valeurs manquantes
na_latitude <- vl[is.na(vl$lat), ]
na_longitude <- vl[is.na(vl$long), ]

# Suppression des lignes avec des valeurs manquantes dans les colonnes latitude et longitude
vl <- vl %>%
  filter(!is.na(lat) & !is.na(long))

# Vérification après suppression
summary(vl$lat)
summary(vl$long)

```


```{r}
library(dplyr)
head(vl %>% select(lat, long))
summary(vl$lat)
summary(vl$long)

```

```{r}

# Conversion de la colonne date si elle existe 
vl <- vl %>%
  mutate(date_accident = as.Date(date, format = "%Y-%m-%d"))

# Conversion de l'heure 
#vl <- vl %>%
#  mutate(heure_accident = as.POSIXct(hrmn, format = "%H:%M"))

```


```{r}
summary(vl)
str(vl)
vl <- vl[vl$lat >= 41 & vl$lat <= 51 & vl$long >= -5 & vl$long <= 10, ]

```
## ANALYSE TEMPORELLE
```{r}
# Étape 1 : Agrégation des données
# Compter les accidents par jour
accidents_par_jour <- vl %>%
  group_by(date) %>%
  summarise(nombre_accidents = n())

# Compter les accidents par mois
accidents_par_mois <- vl %>%
  group_by(month = format(date, "%Y-%m")) %>%
  summarise(nombre_accidents = n())

# Compter les accidents par année
accidents_par_annee <- vl %>%
  group_by(annee = format(date_accident, "%Y")) %>%
  summarise(nombre_accidents = n())
# Étape 2 : Visualisation des tendances
# Installer le package ggplot2 si nécessaire
#install.packages("ggplot2")
library(ggplot2)

# Graphique des accidents par jour
ggplot(accidents_par_jour, aes(x = date, y = nombre_accidents)) +
  geom_line() +
  labs(title = "Nombre d'accidents de vélo par jour",
       x = "Date",
       y = "Nombre d'accidents") +
  theme_minimal()

# Graphique des accidents par mois
ggplot(accidents_par_mois, aes(x = month, y = nombre_accidents)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'accidents de vélo par mois",
       x = "Mois",
       y = "Nombre d'accidents") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Graphique des accidents par année
ggplot(accidents_par_annee, aes(x = annee, y = nombre_accidents)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'accidents de vélo par année",
       x = "Année",
       y = "Nombre d'accidents") +
  theme_minimal()

```


```{r}
# Étape 4 : Analyse de la saisonnalité
unique(vl$mois)
# Créer un vecteur de mois en français
mois_labels <- c("janvier", "février", "mars", "avril", "mai", "juin", 
                 "juillet", "août", "septembre", "octobre", "novembre", "décembre")

# Créer un vecteur de niveaux correspondant (assurez-vous qu'ils correspondent à vos données)
mois_levels <- c("janvier", "février", "mars", "avril", "mai", "juin", 
                 "juillet", "août", "septembre", "octobre", "novembre", "décembre")

# Vérifier si la colonne est déjà un facteur
if (!is.factor(vl$mois)) {
  vl$mois <- factor(vl$mois, levels = mois_levels, labels = mois_labels, ordered = TRUE)
}

# Vérifier les NA après conversion
sum(is.na(vl$mois))

# Visualiser le nombre d'accidents de vélo par mois
ggplot(vl, aes(x = mois)) +
  geom_bar() +
  labs(title = "Nombre d'accidents de vélo par mois (saisonnalité)", x = "Mois", y = "Nombre d'accidents") +
  theme_minimal()

# Créer un tableau avec le nombre d'accidents par année
accidents_by_year <- as.data.frame(table(vl$an))

# Renommer les colonnes pour plus de clarté
colnames(accidents_by_year) <- c("year", "number_of_accidents")

str(accidents_by_year$year)
accidents_by_year$year <- as.numeric(as.character(accidents_by_year$year))

# Convertir en série temporelle (ts)
accidents_ts <- ts(accidents_by_year$number_of_accidents, 
                   start = as.numeric(min(accidents_by_year$year)), 
                   end = as.numeric(max(accidents_by_year$year)), 
                   frequency = 1)

# Visualiser la série temporelle
plot(accidents_ts, main = "Nombre d'accidents de vélo par année", xlab = "Année", ylab = "Nombre d'accidents")


```
```{r}
# Charger le package forecast
install.packages("forecast")
library(forecast)
print(accidents_ts)

# Ajustement du modèle ARIMA
model <- auto.arima(accidents_ts)
summary(model)

# Prévisions sur les 5 prochaines années
forecasted <- forecast(model, h = 5)

# Visualiser les prévisions
plot(forecasted, main = "Prévision du nombre d'accidents de vélo", xlab = "Année", ylab = "Nombre d'accidents")


```


```{r}
#install.packages("leaflet")
library(leaflet)

# Créer une carte avec leaflet
leaflet(vl) %>%
  addTiles() %>%  
  addCircleMarkers(~long, ~lat, radius = 2, color = "red", 
                   popup = ~paste("Accident à:", date_accident))

```

```{r}
# Installer les packages nécessaires
#install.packages("leaflet")
#install.packages("leaflet.extras")  # Pour la carte de chaleur
library(leaflet)
library(leaflet.extras)

# Étape 1 : Visualiser les accidents sur une carte
leaflet(vl) %>%
  addTiles() %>%  # Ajouter la carte de base
  addCircleMarkers(~long, ~lat, radius = 2, color = "red", 
                   popup = ~paste("Accident à:", date_accident),
                   clusterOptions = markerClusterOptions())  # Ajoute un cluster pour les points

# Étape 2 : Créer une carte de chaleur
leaflet(vl) %>%
  addTiles() %>%  # Ajouter la carte de base
  addHeatmap(
    lng = ~long, 
    lat = ~lat, 
    radius = 15, 
    blur = 20, 
    max = 0.05, 
    group = "Heatmap"
  )
```




```{r}
unique(vl)
vl2 <- vl %>%
  select(Num_Acc, an, mois)
head(vl2)
vlgrp <- vl2 %>%
  group_by(an, mois) %>%
  summarise(total_accidents = n())
head(vlgrp)
#install.packages("writexl")
library(writexl)
write_xlsx(vlgrp, "NbrAccpmois.xlsx")
# Calculer le nombre de lignes pour chaque année
nbre_lignes_par_annee <- vl %>%
    group_by(an) %>%
    summarise(n = n())  # Compte le nombre de lignes pour chaque année

# Affichez le résultat
print(nbre_lignes_par_annee)

```

